<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد تحلیل مالی باغ پرندگان</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #0A0A2A;
            color: #E6E6FA;
            background-image: 
                radial-gradient(circle at top left, rgba(0, 245, 255, 0.1), transparent 40%),
                radial-gradient(circle at bottom right, rgba(255, 0, 255, 0.1), transparent 40%),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill='%230f172a' fill-opacity='0.4'%3E%3Crect x='0' y='0' width='50' height='50'/%3E%3Crect x='50' y='50' width='50' height='50'/%3E%3C/g%3E%3C/svg%3E");
        }
        .card {
            background-color: rgba(22, 27, 61, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 1.25rem;
            border: 1px solid rgba(0, 245, 255, 0.2);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.1), inset 0 0 10px rgba(0, 245, 255, 0.05);
        }
        .card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: rgba(0, 245, 255, 0.7);
            box-shadow: 0 0 45px rgba(0, 245, 255, 0.3);
        }
        .gradient-text {
            background: linear-gradient(90deg, #00F5FF, #FF00FF, #00F5FF);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: text-glow 5s linear infinite;
        }
        @keyframes text-glow {
            to { background-position: 200% center; }
        }
        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 8px;
            background: rgba(0, 245, 255, 0.2);
            border-radius: 5px; outline: none;
            --slider-thumb-color: hsl(185, 100%, 50%);
            --slider-shadow-color: hsl(185, 100%, 60%);
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 28px; height: 28px;
            background: var(--slider-thumb-color); cursor: pointer;
            border-radius: 50%; border: 4px solid #0A0A2A;
            box-shadow: 0 0 15px var(--slider-thumb-color), 0 0 8px #fff;
            transition: all 0.2s ease-in-out;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        .tooltip-container { position: relative; display: inline-block; }
        .tooltip-text {
            visibility: hidden; width: 240px; background-color: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); color: #fff; text-align: center;
            border-radius: 8px; padding: 10px; position: absolute; z-index: 10; bottom: 125%; left: 50%;
            margin-left: -120px; opacity: 0; transition: opacity 0.3s; border: 1px solid rgba(0, 245, 255, 0.6);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.3); font-family: 'Vazirmatn', sans-serif;
        }
        .tooltip-text::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: rgba(0, 245, 255, 0.8) transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .neon-email { color: #cffafe; text-shadow: 0 0 4px #00F5FF, 0 0 8px #00F5FF; font-weight: 500; }
        .chart-container { height: 300px; }
        @media (min-width: 640px) { .chart-container { height: 350px; } }
        .fcf-chart-container { height: 350px; }
        @media (min-width: 640px) { .fcf-chart-container { height: 400px; } }
        footer { position: relative; padding-top: 1.5rem; }
        footer::before {
            content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 200px; height: 1px; background: linear-gradient(90deg, transparent, rgba(0, 245, 255, 0.8), transparent);
            box-shadow: 0 0 8px rgba(0, 245, 255, 0.5);
        }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; padding: 0 1rem; }
        .accordion-button.open .accordion-chevron { transform: rotate(180deg); }
        .selector-btn {
            padding: 0.5rem 1rem; border: 1px solid rgba(0, 245, 255, 0.3); border-radius: 0.75rem;
            background-color: transparent; color: rgba(230, 230, 250, 0.7); font-weight: 500;
            transition: all 0.3s ease; white-space: nowrap; font-size: 0.875rem;
        }
        .selector-btn.active {
            background-color: rgba(0, 245, 255, 0.2); color: #E6E6FA;
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.3); border-color: rgba(0, 245, 255, 0.7);
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold gradient-text">تحلیل مالی داینامیک باغ پرندگان</h1>
            <p class="text-base sm:text-lg text-gray-400 mt-2">سناریوی پروژه را انتخاب و تاثیر نرخ تنزیل را بر شاخص‌ها مشاهده کنید</p>
        </header>

        <!-- Controls Section -->
        <section class="mb-8 p-6 card flex flex-col items-center gap-y-6">
            <div id="scenarioSelector" class="w-full flex flex-col items-center gap-4">
                <div>
                    <h2 class="text-lg font-semibold text-cyan-300 text-center mb-3">سناریوهای ۲۵ ساله (سرمایه‌گذاری ~۹۷۰ میلیارد ریال)</h2>
                    <div class="flex flex-wrap justify-center gap-2 p-1 bg-gray-900/30 rounded-xl">
                        <button class="selector-btn" data-scenario="s1">نرخ تنزیل ۴۰٪</button>
                        <button class="selector-btn active" data-scenario="s2">نرخ تنزیل ۳۰٪</button>
                        <button class="selector-btn" data-scenario="s3">نرخ تنزیل ۲۰٪</button>
                    </div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-fuchsia-400 text-center mb-3">سناریوهای ۲۰ ساله (سرمایه‌گذاری ~۵۶۵ میلیارد ریال)</h2>
                    <div class="flex flex-wrap justify-center gap-2 p-1 bg-gray-900/30 rounded-xl">
                        <button class="selector-btn" data-scenario="s4">نرخ تنزیل ۴۰٪</button>
                        <button class="selector-btn" data-scenario="s5">نرخ تنزیل ۳۰٪</button>
                        <button class="selector-btn" data-scenario="s6">نرخ تنزیل ۲۰٪</button>
                    </div>
                </div>
            </div>
            <!-- Slider Section -->
            <div class="w-full max-w-4xl pt-4">
                <label for="discountRateSlider" class="block text-xl font-bold text-center text-cyan-300 mb-4">
                    نرخ تنزیل: <span id="sliderValue" class="gradient-text font-mono text-2xl">30.0%</span>
                </label>
                <input id="discountRateSlider" type="range" min="0" max="60" value="30" step="0.5" class="w-full">
            </div>
        </section>

        <!-- Dynamic Metrics -->
        <section class="mb-12 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 md:gap-6">
            <div class="card p-4 text-center"><h3 class="text-sm font-semibold text-gray-400 mb-2">سرمایه‌گذاری (CAPEX)</h3><p id="dynamicCapex" class="text-xl sm:text-2xl font-bold text-cyan-300">-</p></div>
            <div class="card p-4 text-center"><h3 class="text-sm font-semibold text-gray-400 mb-2">خالص ارزش فعلی (NPV)</h3><p id="dynamicNpv" class="text-xl sm:text-2xl font-bold text-cyan-300">-</p></div>
            <div class="card p-4 text-center"><h3 class="text-sm font-semibold text-gray-400 mb-2">نرخ بازده داخلی (IRR)</h3><p id="dynamicIrr" class="text-xl sm:text-2xl font-bold text-cyan-300">-</p></div>
            <div class="card p-4 text-center"><h3 class="text-sm font-semibold text-gray-400 mb-2">نسبت درآمد به هزینه (B/C)</h3><p id="dynamicBC" class="text-xl sm:text-2xl font-bold text-cyan-300">-</p></div>
            <div class="card p-4 text-center"><h3 class="text-sm font-semibold text-gray-400 mb-2">بازگشت سرمایه (PP)</h3><p id="dynamicPP" class="text-xl sm:text-2xl font-bold text-cyan-300">-</p></div>
            <div class="card p-4 text-center"><h3 class="text-sm font-semibold text-gray-400 mb-2">بازگشت سود و سرمایه (DPBP)</h3><p id="dynamicDPBP" class="text-xl sm:text-2xl font-bold text-cyan-300">-</p></div>
        </section>
        
        <!-- RESTORED: STRATEGIC ANALYSIS SECTION -->
        <section class="mb-12 card p-6">
            <h2 class="text-xl sm:text-2xl font-bold text-cyan-300 mb-6 text-center">تحلیل استراتژیک روابط شاخص‌ها</h2>
            <div id="accordion-container" class="space-y-4">
                <!-- Item 1 -->
                <div>
                    <button class="accordion-button w-full flex justify-between items-center text-right p-4 bg-gray-900/30 hover:bg-cyan-400/10 rounded-lg transition-colors duration-300">
                        <span class="flex items-center gap-x-3 font-semibold text-gray-200 text-base sm:text-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                            <span>۱. حاشیه امنیت پروژه: رابطه IRR و نرخ تنزیل</span>
                        </span>
                        <svg class="accordion-chevron h-5 w-5 text-gray-400 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content">
                        <div class="pt-4 pb-4 text-gray-300 leading-relaxed text-sm sm:text-base">
                            <p class="mb-2"><strong class="font-semibold text-cyan-300">تفسیر مدیریتی:</strong> نرخ بازده داخلی (IRR) هر سناریو، حداکثر نرخ تنزیلی است که پروژه می‌تواند تحمل کند و همچنان اقتصادی باشد (NPV>0). هرچه فاصله IRR از نرخ تنزیل انتخابی شما بیشتر باشد، حاشیه امنیت پروژه در برابر ریسک‌ها و افزایش هزینه‌ها بالاتر است. در این مدل‌ها، IRR بسیار نزدیک به نرخ تنزیل مرجع است که نشانگر حاشیه امنیت <strong class="text-orange-400">محدود</strong> است.</p>
                        </div>
                    </div>
                </div>
                <!-- Item 2 -->
                <div>
                    <button class="accordion-button w-full flex justify-between items-center text-right p-4 bg-gray-900/30 hover:bg-cyan-400/10 rounded-lg transition-colors duration-300">
                        <span class="flex items-center gap-x-3 font-semibold text-gray-200 text-base sm:text-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                            <span>۲. خلق ارزش: چرا NPV به شدت متغیر است؟</span>
                        </span>
                        <svg class="accordion-chevron h-5 w-5 text-gray-400 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content">
                        <div class="pt-4 pb-4 text-gray-300 leading-relaxed text-sm sm:text-base">
                            <p>ارزش خالص فعلی (NPV) نشان‌دهنده ارزش خلق‌شده توسط پروژه است. تغییرات آن با حرکت اسلایدر، از تأثیر اهرمی نرخ تنزیل بر جریانات نقدی بلندمدت ناشی می‌شود. با انتخاب سناریوهای مختلف و تغییر نرخ تنزیل، می‌توانید ببینید کدام سناریو در شرایط مختلف ریسک، بیشترین ارزش را ایجاد می‌کند.</p>
                             <p><strong class="font-semibold text-cyan-300">نکته استراتژیک:</strong> سناریوی سرمایه‌گذاری بالاتر به طور طبیعی پتانسیل ایجاد بیشترین NPV را دارد، اما در نرخ‌های تنزیل بالا شکننده‌تر است. در مقابل، سناریوی سرمایه‌گذاری پایین‌تر، امن‌تر اما با سودآوری بالقوه کمتری است.</p>
                        </div>
                    </div>
                </div>
                <!-- Item 3 -->
                <div>
                    <button class="accordion-button w-full flex justify-between items-center text-right p-4 bg-gray-900/30 hover:bg-cyan-400/10 rounded-lg transition-colors duration-300">
                        <span class="flex items-center gap-x-3 font-semibold text-gray-200 text-base sm:text-lg">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <span>۳. ساختار ریسک: دوره بازگشت طولانی (DPBP)</span>
                        </span>
                        <svg class="accordion-chevron h-5 w-5 text-gray-400 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content">
                        <div class="pt-4 pb-4 text-gray-300 leading-relaxed text-sm sm:text-base">
                             <p class="mb-2"><strong class="font-semibold text-cyan-300">علت ساختاری:</strong> دوره بازگشت سرمایه تنزیل شده (DPBP) در اغلب سناریوها طولانی و نزدیک به انتهای دوره پروژه است. این یعنی مدل جریان نقدی به صورت "سنگین در انتها" (Back-loaded) طراحی شده و بخش عمده سود در سال‌های پایانی محقق می‌شود.</p>
                            <p><strong class="font-semibold text-cyan-300">پیامد مدیریتی:</strong> این ساختار یک ریسک استراتژیک مهم را معرفی می‌کند: <strong class="text-orange-400">وابستگی شدید به عملکرد بلندمدت</strong>. موفقیت پروژه به ثبات بازار و تحقق درآمدهای بزرگ در سال‌های پایانی دوره گره خورده است.</p>
                        </div>
                    </div>
                </div>
                <!-- Item 4 -->
                <div>
                    <button class="accordion-button w-full flex justify-between items-center text-right p-4 bg-gray-900/30 hover:bg-cyan-400/10 rounded-lg transition-colors duration-300">
                        <span class="flex items-center gap-x-3 font-semibold text-gray-200 text-base sm:text-lg">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" /></svg>
                            <span>۴. مقیاس‌پذیری و سرمایه‌گذاری (CAPEX)</span>
                        </span>
                        <svg class="accordion-chevron h-5 w-5 text-gray-400 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content">
                        <div class="pt-4 pb-4 text-gray-300 leading-relaxed text-sm sm:text-base">
                             <p class="mb-2">این ۶ سناریو را می‌توان به عنوان دو طرح کسب‌وکار با دو مقیاس سرمایه‌گذاری متفاوت (حدود ۵۶۵ و ۹۷۰ میلیارد ریال) در نظر گرفت که هر کدام تحت سه فرض نرخ تنزیل متفاوت (۲۰٪، ۳۰٪ و ۴۰٪) ارزیابی شده‌اند.</p>
                            <p><strong class="font-semibold text-cyan-300">سوال استراتژیک:</strong> «کدام مقیاس از سرمایه‌گذاری، با توجه به ارزیابی ما از ریسک آینده، بهینه ترین بازده تعدیل‌شده بر اساس ریسک (Risk-Adjusted Return) را ارائه می‌دهد؟»</p>
                        </div>
                    </div>
                </div>
                 <!-- Item 5 -->
                <div>
                    <button class="accordion-button w-full flex justify-between items-center text-right p-4 bg-gray-900/30 hover:bg-cyan-400/10 rounded-lg transition-colors duration-300">
                        <span class="flex items-center gap-x-3 font-semibold text-gray-200 text-base sm:text-lg">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg>
                            <span>۵. اگر سرمایه‌گذاری اولیه تغییر کند چه اتفاقی می‌افتد؟</span>
                        </span>
                        <svg class="accordion-chevron h-5 w-5 text-gray-400 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content">
                        <div class="pt-4 pb-4 text-gray-300 leading-relaxed text-sm sm:text-base">
                             <p class="mb-4">این رابطه کاملاً معکوس است. هرچقدر هزینه اولیه سرمایه‌گذاری برای باغ پرندگان کمتر باشد، بازدهی بالاتر و ریسک پروژه نیز کمتر خواهد بود.</p>
                             <div class="overflow-x-auto">
                                <table class="w-full text-center border border-cyan-500/30 rounded-lg">
                                    <thead class="bg-gray-900/30">
                                        <tr>
                                            <th class="p-3 border-b border-l border-cyan-500/30 font-semibold">اگر سرمایه‌گذاری اولیه...</th>
                                            <th class="p-3 border-b border-l border-cyan-500/30 font-semibold">نرخ بازده داخلی (IRR)...</th>
                                            <th class="p-3 border-b border-cyan-500/30 font-semibold">دوره بازگشت سود و سرمایه (DPBP)...</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="hover:bg-cyan-500/10">
                                            <td class="p-3 border-b border-l border-cyan-500/30 text-orange-400">کم شود (ارزان‌تر بخرید)</td>
                                            <td class="p-3 border-b border-l border-cyan-500/30 text-green-400">بالا می‌رود (سودآوری بیشتر می‌شود)</td>
                                            <td class="p-3 border-b border-cyan-500/30 text-green-400">کوتاه‌تر می‌شود (سریع‌تر پولتان برمی‌گردد)</td>
                                        </tr>
                                        <tr class="hover:bg-cyan-500/10">
                                            <td class="p-3 border-l border-cyan-500/30 text-orange-400">زیاد شود (گران‌تر بخرید)</td>
                                            <td class="p-3 border-l border-cyan-500/30 text-red-400">پایین می‌آید (سودآوری کمتر می‌شود)</td>
                                            <td class="p-3 border-cyan-500/30 text-red-400">طولانی‌تر می‌شود (دیرتر پولتان برمی‌گردد)</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>


        <!-- Charts Grid -->
        <section class="mb-12 grid grid-cols-1 lg:grid-cols-2 gap-8">
             <div class="card p-4"><h3 id="roadmapChartTitle" class="text-base sm:text-lg font-semibold text-center mb-4 text-gray-300">نقشه راه زمانی پروژه</h3><div class="chart-container"><canvas id="newRoadmapChart"></canvas></div></div>
             <div class="card p-4"><h3 class="text-base sm:text-lg font-semibold text-center mb-4 text-gray-300">تحلیل حساسیت NPV به نرخ تنزیل</h3><div class="chart-container"><div id="npvVsRateChart"></div></div></div>
             
             <div class="card p-6 lg:col-span-2">
                <h3 class="text-lg sm:text-xl font-bold text-center mb-4 gradient-text">تحلیل جریان نقدی آزاد و تجمعی</h3>
                <div class="fcf-chart-container">
                    <canvas id="fcfChart"></canvas>
                </div>
            </div>
        </section>

        <!-- REDESIGNED Graphical Table -->
        <section>
            <h2 class="text-xl sm:text-2xl font-bold text-cyan-300 mb-6 text-center">مقایسه گرافیکی سناریوهای مرجع</h2>
            <div id="graphicalTableContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- JS will generate this content -->
            </div>
            <p class="text-center text-gray-400 text-sm mt-4">توجه: کلیه مقادیر عددی (به جز درصد و سال) بر حسب میلیارد ریال است.</p>
        </section>

        <footer class="text-center mt-12 text-gray-500 text-sm">
            <div class="tooltip-container">
                تهیه شده در مهندسین مشاور ایده پرداز محیط
                <span class="tooltip-text">
                    تحلیل و طراحی: حمیدرضا ترابی
                    <br>
                    <span class="neon-email">hr.torabii@gmail.com</span>
                </span>
            </div>
            <p class="mt-2">پاییز 1404</p>
        </footer>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DATA STRUCTURE BASED ON THE 6 FIXED SCENARIOS ---
        const projectData = {
            s1: { name: "دوره ۲۵ ساله، سرمایه‌گذاری ~۹۷۰ میلیارد", period: 25, ref_rate: 40, capex: 970, irr: 40.2, pp: 3.33, dpbp_ref: 24.54, npv_ref: 0.72, color: 'orange', fcf: [244.5, 281.1, 323.3, 371.8, 427.6, 491.7, 565.5, 650.3, 747.8, 860, 989, 1137.3, 1307.9, 1504.1, 1729.7, 1989.2, 2287.6, 2630.7, 3025.3, 3479.1, 4001, 4601.1, 5291.3, 6085, 6997.7] },
            s2: { name: "دوره ۲۵ ساله، سرمایه‌گذاری ~۹۷۵ میلیارد", period: 25, ref_rate: 30, capex: 975, irr: 30.07, pp: 4.75, dpbp_ref: 24.39, npv_ref: 3.84, color: 'cyan', fcf: [154, 177.1, 203.7, 234.2, 269.4, 309.8, 356.2, 409.7, 471.1, 541.8, 623.1, 716.5, 824, 947.6, 1089.7, 1253.2, 1441.2, 1657.4, 1906, 2191.9, 2520.8, 2898.9, 3333.8, 3833.8, 4408.9] },
            s3: { name: "دوره ۲۵ ساله، سرمایه‌گذاری ~۹۷۰ میلیارد", period: 25, ref_rate: 20, capex: 970, irr: 20.04, pp: 11.01, dpbp_ref: 24.91, npv_ref: 5.36, color: 'fuchsia', fcf: [4.6, 7.4, 11.8, 19, 30.3, 48.5, 77.7, 124.2, 161.5, 209.9, 272.9, 354.8, 461.3, 599.7, 779.6, 1013.4, 1317.5, 1580.9, 1897.2, 2276.6, 2732, 3278.4, 3934, 4720.8, 5665] },
            s4: { name: "دوره ۲۰ ساله، سرمایه‌گذاری ~۵۷۵ میلیارد", period: 20, ref_rate: 40, capex: 575, irr: 40.19, pp: 3.63, dpbp_ref: 18.98, npv_ref: 4.74, color: 'orange', fcf: [121.5, 145.8, 175, 210, 252, 302.4, 362.8, 435.4, 522.5, 627, 752.4, 902.9, 1083.5, 1300.2, 1560.2, 1872.2, 2246.7, 2696, 3235.2, 3882.3] },
            s5: { name: "دوره ۲۰ ساله، سرمایه‌گذاری ~۵۷۵ میلیارد", period: 20, ref_rate: 30, capex: 575, irr: 30.29, pp: 5.2, dpbp_ref: 19.05, npv_ref: 10.02, color: 'cyan', fcf: [66.2, 82.8, 103.5, 129.4, 161.7, 202.2, 252.7, 315.9, 363.3, 417.8, 480.4, 552.5, 635.4, 730.7, 840.3, 966.3, 1111.3, 1189.1, 1272.3, 2000] },
            s6: { name: "دوره ۲۰ ساله، سرمایه‌گذاری ~۵۵۰ میلیارد", period: 20, ref_rate: 20, capex: 550, irr: 20.46, pp: 8.53, dpbp_ref: 19.82, npv_ref: 26.10, color: 'fuchsia', fcf: [25.3, 31.6, 39.5, 49.4, 61.7, 77.1, 96.4, 120.5, 138.6, 159.4, 183.3, 210.8, 242.4, 278.8, 320.6, 368.7, 424, 453.7, 485.4, 5500] }
        };

        let currentScenarioKey = 's2';

        // --- ELEMENTS ---
        const slider = document.getElementById('discountRateSlider');
        const sliderValueEl = document.getElementById('sliderValue');
        const scenarioSelector = document.getElementById('scenarioSelector');
        const dynamicElements = {
            capex: document.getElementById('dynamicCapex'), npv: document.getElementById('dynamicNpv'), irr: document.getElementById('dynamicIrr'),
            bc: document.getElementById('dynamicBC'), pp: document.getElementById('dynamicPP'), dpbp: document.getElementById('dynamicDPBP'),
        };

        // --- ACCORDION SCRIPT ---
        document.getElementById('accordion-container').addEventListener('click', (e) => { const btn = e.target.closest('.accordion-button'); if (!btn) return; const content = btn.nextElementSibling; btn.classList.toggle('open'); if (content.style.maxHeight) { content.style.maxHeight = null; content.style.padding = "0 1rem"; } else { content.style.maxHeight = content.scrollHeight + "px"; content.style.padding = "1rem 1rem 0.5rem 1rem"; } });

        // --- CALCULATION HELPERS ---
        const calculateNpv = (rate, fcf, capex) => { let npv = -capex; const dr = rate / 100; fcf.forEach((cf, i) => { npv += cf / Math.pow(1 + dr, i + 1); }); return npv; };
        const calculateBCRatio = (rate, fcf, capex) => { if (capex <= 0) return Infinity; let pvBenefits = 0; const dr = rate / 100; fcf.forEach((cf, i) => { pvBenefits += cf / Math.pow(1 + dr, i + 1); }); return pvBenefits / capex; };
        const calculateDPBP = (rate, fcf, capex, period) => { let cumulativeDiscountedCf = -capex; const dr = rate / 100; for (let i = 0; i < fcf.length; i++) { const discountedCf = fcf[i] / Math.pow(1 + dr, i + 1); if (discountedCf <= 0) continue; cumulativeDiscountedCf += discountedCf; if (cumulativeDiscountedCf >= 0) return (i + 1) - (cumulativeDiscountedCf / discountedCf); } return `> ${period}`; };
        const calculateCumulativeFcf = (fcf, capex) => { const cumulative = []; let sum = -capex; for (const val of fcf) { sum += val; cumulative.push(sum); } return cumulative; };

        // --- CHART SETUP ---
        const tickColor = '#a3a3a3', gridColor = 'rgba(0, 245, 255, 0.1)', legendColor = '#E6E6FA', vazirFont = 'Vazirmatn';
        const defaultChartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: legendColor, font: { family: vazirFont, size: 14 } } }, tooltip: { enabled: true, bodyFont: { family: vazirFont }, titleFont: { family: vazirFont }, backgroundColor: 'rgba(10, 10, 42, 0.85)', borderColor: 'rgba(0, 245, 255, 0.5)', borderWidth: 1, padding: 12, displayColors: true, boxPadding: 4, } }, };
        const fcfCanvas = document.getElementById('fcfChart');
        const fcfChartCtx = fcfCanvas.getContext('2d');
        const fcfGradient = fcfChartCtx.createLinearGradient(0, 0, 0, fcfCanvas.offsetHeight);
        fcfGradient.addColorStop(0, 'rgba(0, 245, 255, 0.6)'); fcfGradient.addColorStop(1, 'rgba(0, 245, 255, 0.1)');
        const fcfChart = new Chart(fcfChartCtx, { type: 'line', data: { labels: [], datasets: [ { label: 'جریان نقدی آزاد (FCF)', data: [], borderColor: '#00F5FF', backgroundColor: fcfGradient, fill: true, tension: 0.4, borderWidth: 2 }, { label: 'جریان نقدی تجمعی', data: [], borderColor: '#FF00FF', backgroundColor: 'transparent', tension: 0.4, fill: false, pointRadius: 3, pointBackgroundColor: '#FF00FF', pointHoverRadius: 6, borderWidth: 3 } ] }, options: { ...defaultChartOptions, interaction: { mode: 'index', intersect: false }, scales: { x: { ticks: { color: tickColor, font: { family: vazirFont } }, grid: { display: false } }, y: { ticks: { color: tickColor, font: { family: vazirFont } }, grid: { color: gridColor } } }, plugins: { ...defaultChartOptions.plugins, tooltip: { ...defaultChartOptions.plugins.tooltip, mode: 'index', intersect: false }, annotation: { annotations: { zeroLine: { type: 'line', yMin: 0, yMax: 0, borderColor: 'rgba(255, 204, 0, 0.8)', borderWidth: 2, borderDash: [5, 5], label: { content: 'نقطه سر به سر', enabled: true, position: 'start', font: { family: vazirFont, size: 12, weight: 'bold' }, backgroundColor: 'rgba(255, 204, 0, 0.2)', color: 'rgba(255, 204, 0, 1)' } } } } } } });
        const npvChartOptions = { series: [{ name: 'NPV', data: [] }], chart: { type: 'line', height: '100%', background: 'transparent', fontFamily: 'Vazirmatn, sans-serif', toolbar: { show: false } }, theme: { mode: 'dark' }, colors: ['#FF00FF'], stroke: { curve: 'smooth', width: 3 }, grid: { borderColor: gridColor, xaxis: { lines: { show: false } } }, xaxis: { type: 'numeric', title: { text: 'نرخ تنزیل', style: { color: legendColor } }, labels: { formatter: val => `${val.toFixed(0)}%`, style: { colors: tickColor } } }, yaxis: { title: { text: 'خالص ارزش فعلی (NPV)', style: { color: legendColor } }, labels: { formatter: val => val.toLocaleString('fa-IR'), style: { colors: tickColor } } }, tooltip: { theme: 'dark', x: { formatter: val => `نرخ: ${val.toFixed(1)}%` }, y: { formatter: val => val.toLocaleString('fa-IR', {maximumFractionDigits: 0}) } }, annotations: { xaxis: [], yaxis: [] } };
        const npvVsRateChart = new ApexCharts(document.querySelector("#npvVsRateChart"), npvChartOptions);
        npvVsRateChart.render();
        const newRoadmapChart = new Chart(document.getElementById('newRoadmapChart').getContext('2d'), { type: 'bar', data: { labels: ['دوران بهره\u200cبرداری', 'بازگشت سود و سرمایه', 'بازگشت سرمایه'], datasets: [{ data: [], backgroundColor: ['rgba(0, 220, 150, 0.7)', 'rgba(255, 0, 128, 0.7)', 'rgba(255, 165, 0, 0.7)'], borderWidth: 1, borderColor: '#0A0A2A', barPercentage: 0.5, borderRadius: 5 }] }, options: { ...defaultChartOptions, indexAxis: 'y', plugins: {...defaultChartOptions.plugins, legend: {display: false}, tooltip: {callbacks: { label: (ctx) => ` ${ctx.raw[1].toFixed(1)} سال`}}}, scales: { x: { min: 0, max: 25, ticks: { color: tickColor, stepSize: 5 }, grid: { color: gridColor }, title: { display: true, text: 'سال\u200cهای بهره\u200cبرداری', color: legendColor, font: { family: vazirFont } } }, y: { ticks: {color: tickColor, font:{family: vazirFont}}, grid: { display: false } } } } });

        // --- DYNAMIC UPDATE FUNCTIONS ---
        function updateGraphicalTable() {
            const container = document.getElementById('graphicalTableContainer');
            container.innerHTML = ''; 
            const scenarios = ['s1', 's2', 's3', 's4', 's5', 's6'];
            
            const icons = {
                capex: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>`,
                npv: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>`,
                irr: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg>`,
                pp: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                dpbp: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`
            };
            const colors = { orange: 'text-orange-300', cyan: 'text-cyan-300', fuchsia: 'text-fuchsia-400' };

            const rightCol = document.createElement('div');
            rightCol.className = "grid grid-cols-1 gap-6";
            const leftCol = document.createElement('div');
            leftCol.className = "grid grid-cols-1 gap-6";
            
            scenarios.forEach((scenKey) => {
                const data = projectData[scenKey];
                const cardColor = data.color;

                const cardHTML = `
                    <div class="card p-5 border-l-4" style="border-left-color: var(--tw-color-${cardColor}-500, ${cardColor})">
                        <h3 class="font-bold text-lg ${colors[cardColor]}">سناریوی ${scenKey.substring(1)}</h3>
                        <p class="text-sm text-gray-400 mb-4">${data.name} | نرخ تنزیل مرجع: ${data.ref_rate}%</p>
                        <div class="space-y-3 text-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-400 flex items-center gap-x-2">${icons.capex} سرمایه‌گذاری (CAPEX)</span>
                                <span class="font-mono text-white">${data.capex.toLocaleString('fa-IR')}</span>
                            </div>
                            <div class="flex items-center justify-between pt-2 border-t border-gray-700/50">
                                <span class="text-gray-300 flex items-center gap-x-2 font-semibold">${icons.irr} نرخ بازده داخلی (IRR)</span>
                                <span class="font-mono text-xl font-bold ${colors[cardColor]}">${data.irr.toLocaleString('fa-IR')}%</span>
                            </div>
                             <div class="flex items-center justify-between">
                                <span class="text-gray-300 flex items-center gap-x-2 font-semibold">${icons.npv} خالص ارزش فعلی (NPV)</span>
                                <span class="font-mono text-xl font-bold ${data.npv_ref >= 0 ? 'text-green-400' : 'text-red-400'}">${data.npv_ref.toLocaleString('fa-IR', {maximumFractionDigits:2})}</span>
                            </div>
                            <div class="flex items-center justify-between pt-2 border-t border-gray-700/50">
                                <span class="text-gray-400 flex items-center gap-x-2">${icons.pp} بازگشت سرمایه (PP)</span>
                                <span class="font-mono text-white">${data.pp.toLocaleString('fa-IR')} سال</span>
                            </div>
                             <div class="flex items-center justify-between">
                                <span class="text-gray-400 flex items-center gap-x-2">${icons.dpbp} بازگشت سود و سرمایه (DPBP)</span>
                                <span class="font-mono text-white">${data.dpbp_ref.toLocaleString('fa-IR')} سال</span>
                            </div>
                        </div>
                    </div>
                `;
                // Scenarios 4, 5, 6 on the right (first column in RTL)
                if (['s4', 's5', 's6'].includes(scenKey)) {
                     rightCol.innerHTML += cardHTML;
                } 
                // Scenarios 1, 2, 3 on the left (second column in RTL)
                else {
                     leftCol.innerHTML += cardHTML;
                }
            });
            container.appendChild(rightCol);
            container.appendChild(leftCol);
        }

        function updateDashboard(rate) {
            sliderValueEl.textContent = `${rate.toFixed(1)}%`;
            const data = projectData[currentScenarioKey];

            const npv = calculateNpv(rate, data.fcf, data.capex);
            const bc = calculateBCRatio(rate, data.fcf, data.capex);
            const dpbp = calculateDPBP(rate, data.fcf, data.capex, data.period);
            
            dynamicElements.capex.textContent = data.capex.toLocaleString('fa-IR');
            dynamicElements.irr.textContent = `${data.irr.toFixed(1)}%`;
            dynamicElements.pp.textContent = `${data.pp.toFixed(1)} سال`;
            dynamicElements.npv.textContent = npv.toLocaleString('fa-IR', { maximumFractionDigits: 1 });
            dynamicElements.bc.textContent = (1 + bc).toFixed(4);
            dynamicElements.dpbp.textContent = typeof dpbp === 'number' ? `${dpbp.toFixed(1)} سال` : dpbp;
            
            fcfChart.data.labels = Array.from({length: data.period}, (_, i) => `سال ${i + 1}`);
            fcfChart.data.datasets[0].data = data.fcf;
            fcfChart.data.datasets[1].data = calculateCumulativeFcf(data.fcf, data.capex);
            fcfChart.update();
            
            newRoadmapChart.options.scales.x.max = data.period;
            newRoadmapChart.data.datasets[0].data = [ [0, data.period], typeof dpbp === 'number' ? [0, dpbp] : [0, 0], [0, data.pp] ];
            newRoadmapChart.update();

            npvVsRateChart.updateOptions({
                annotations: {
                    xaxis: [ { x: data.irr, borderColor: '#00E396', label: { text: `IRR: ${data.irr.toFixed(1)}%`, style: { background: '#00E396', color: '#000' } } }, { x: rate, borderColor: '#00F5FF', label: { text: 'نرخ فعلی', style: { background: '#00F5FF', color: '#000' } } } ],
                    yaxis: [{ y: 0, borderColor: '#FF4560', label: { text: 'نقطه سر به سر', style: { background: '#FF4560' } } }]
                }
            });
        }
        
        function reinitializeForScenario(scenarioKey) {
            currentScenarioKey = scenarioKey;
            const data = projectData[scenarioKey];
            
            slider.value = data.ref_rate;

            const npvDataForApex = [];
            for (let r = 0; r <= 60; r += 1) {
                npvDataForApex.push({ x: r, y: parseFloat(calculateNpv(r, data.fcf, data.capex).toFixed(2)) });
            }
            npvVsRateChart.updateSeries([{ data: npvDataForApex }]);
            
            updateDashboard(data.ref_rate);
            updateGraphicalTable(); // Call this once to build the static table
        }

        // --- EVENT LISTENERS ---
        slider.addEventListener('input', (e) => updateDashboard(parseFloat(e.target.value)));

        scenarioSelector.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const newScenarioKey = e.target.dataset.scenario;
                if (newScenarioKey !== currentScenarioKey) {
                    scenarioSelector.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    reinitializeForScenario(newScenarioKey);
                }
            }
        });

        // --- INITIALIZATION ---
        reinitializeForScenario(currentScenarioKey);
    });
    </script>
</body>
</html>

